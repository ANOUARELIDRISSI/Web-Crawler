{% extends "base.html" %}

{% block title %}Sources - Web Crawler{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4"><i class="bi bi-link-45deg"></i> Manage Sources</h1>
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-4" id="sourceTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="quick-crawl-tab" data-bs-toggle="tab" data-bs-target="#quick-crawl" type="button">
            <i class="bi bi-rocket"></i> Quick Crawl
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="configured-tab" data-bs-toggle="tab" data-bs-target="#configured" type="button">
            <i class="bi bi-list"></i> Configured Sources
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="custom-tab" data-bs-toggle="tab" data-bs-target="#custom" type="button">
            <i class="bi bi-plus-circle"></i> Add Custom
        </button>
    </li>
</ul>

<div class="tab-content" id="sourceTabContent">
    <!-- Quick Crawl Tab -->
    <div class="tab-pane fade show active" id="quick-crawl" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title"> Quick Crawl from Default Sources</h5>
                <p class="text-muted">Select a source, configure settings, and start crawling immediately!</p>
                
                <form id="quickCrawlForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Select Source</label>
                            <select class="form-select" id="defaultSource" required>
                                <option value="">Choose a source...</option>
                                {% for category, sources in categories.items() %}
                                    <optgroup label="{{ category }}">
                                        {% for source in sources %}
                                            <option value="{{ loop.index0 }}" 
                                                    data-category="{{ category }}"
                                                    data-name="{{ source.name }}"
                                                    data-url="{{ source.url }}"
                                                    data-type="{{ source.type }}"
                                                    data-description="{{ source.description }}"
                                                    data-selectors='{{ source.selectors | tojson if source.selectors else "{}" }}'>
                                                {{ source.name }}
                                            </option>
                                        {% endfor %}
                                    </optgroup>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div id="sourceInfo" class="alert alert-info" style="display: none;">
                                <strong id="sourceName"></strong><br>
                                <small id="sourceDescription"></small><br>
                                <small><strong>URL:</strong> <span id="sourceUrl"></span></small><br>
                                <small><strong>Type:</strong> <span id="sourceType"></span></small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Max Items</label>
                            <input type="number" class="form-control" id="maxItems" value="20" min="1" max="200" required>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Frequency</label>
                            <select class="form-select" id="frequency">
                                <option value="hourly">Hourly</option>
                                <option value="daily" selected>Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Schedule Time</label>
                            <input type="time" class="form-control" id="scheduleTime" value="09:00">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                <i class="bi bi-rocket"></i> Crawl Now
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button type="button" class="btn btn-outline-primary btn-lg w-100" id="addToSourcesBtn">
                                <i class="bi bi-plus-circle"></i> Add to Sources
                            </button>
                        </div>
                    </div>
                </form>
                
                <!-- Loading -->
                <div class="loading" id="crawlLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Crawling in progress...</p>
                </div>
                
                <!-- Results -->
                <div id="crawlResults" style="display: none;" class="mt-4">
                    <div class="alert alert-success">
                        <h5><i class="bi bi-check-circle"></i> Crawl Successful!</h5>
                        <p id="resultMessage"></p>
                    </div>
                    
                    <h6>Preview of Collected Data:</h6>
                    <div id="dataPreview"></div>
                </div>
                
                <div id="crawlError" style="display: none;" class="mt-4">
                    <div class="alert alert-danger">
                        <h5><i class="bi bi-x-circle"></i> Crawl Failed</h5>
                        <p id="errorMessage"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Configured Sources Tab -->
    <div class="tab-pane fade" id="configured" role="tabpanel">
        <div class="row">
            {% for source in configured_sources %}
            <div class="col-md-6 mb-3">
                <div class="source-card">
                    <h5>{{ source.name }}</h5>
                    <p class="text-muted mb-2"><small>{{ source.url }}</small></p>
                    <div class="mb-2">
                        <span class="badge bg-primary">{{ source.type }}</span>
                        <span class="badge bg-info">{{ source.frequency }}</span>
                        <span class="badge bg-success">{{ source.status }}</span>
                    </div>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-primary" onclick="crawlSource('{{ source._id }}')">
                            <i class="bi bi-play"></i> Crawl Now
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSource('{{ source._id }}')">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="col-12">
                <div class="alert alert-info">
                    No sources configured yet. Use Quick Crawl or Add Custom to get started!
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Add Custom Source Tab -->
    <div class="tab-pane fade" id="custom" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Add Custom Source</h5>
                <form id="customSourceForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Source Name *</label>
                            <input type="text" class="form-control" id="customName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">URL *</label>
                            <input type="url" class="form-control" id="customUrl" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Content Type *</label>
                            <select class="form-select" id="customType" required>
                                <option value="html">HTML</option>
                                <option value="rss">RSS</option>
                                <option value="pdf">PDF</option>
                                <option value="xml">XML</option>
                                <option value="txt">TXT</option>
                                <option value="dynamic">Dynamic (JavaScript)</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Frequency</label>
                            <select class="form-select" id="customFrequency">
                                <option value="hourly">Hourly</option>
                                <option value="daily" selected>Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Max Items</label>
                            <input type="number" class="form-control" id="customMaxItems" value="50" min="1" max="1000">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Add Source
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Show source info when selected
document.getElementById('defaultSource').addEventListener('change', function() {
    const option = this.options[this.selectedIndex];
    if (option.value) {
        document.getElementById('sourceName').textContent = option.dataset.name;
        document.getElementById('sourceDescription').textContent = option.dataset.description;
        document.getElementById('sourceUrl').textContent = option.dataset.url;
        document.getElementById('sourceType').textContent = option.dataset.type.toUpperCase();
        document.getElementById('sourceInfo').style.display = 'block';
    } else {
        document.getElementById('sourceInfo').style.display = 'none';
    }
});

// Quick Crawl Form
document.getElementById('quickCrawlForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const option = document.getElementById('defaultSource').selectedOptions[0];
    if (!option.value) {
        alert('Please select a source');
        return;
    }
    
    const data = {
        name: option.dataset.name,
        url: option.dataset.url,
        type: option.dataset.type,
        max_items: parseInt(document.getElementById('maxItems').value),
        frequency: document.getElementById('frequency').value,
        selectors: JSON.parse(option.dataset.selectors || '{}')
    };
    
    // Show loading
    document.getElementById('crawlLoading').classList.add('active');
    document.getElementById('crawlResults').style.display = 'none';
    document.getElementById('crawlError').style.display = 'none';
    
    try {
        const response = await fetch('/api/crawl', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        document.getElementById('crawlLoading').classList.remove('active');
        
        if (result.success) {
            document.getElementById('resultMessage').textContent = 
                `Successfully crawled ${result.result.items_collected} items from ${data.name}!`;
            document.getElementById('crawlResults').style.display = 'block';
            
            // Show preview
            const preview = document.getElementById('dataPreview');
            preview.innerHTML = '';
            result.recent_data.slice(0, 3).forEach(item => {
                const card = document.createElement('div');
                card.className = 'card mb-2';
                card.innerHTML = `
                    <div class="card-body">
                        <h6>${item.title || 'Untitled'}</h6>
                        <small class="text-muted">${item.type} - ${new Date(item.timestamp).toLocaleString()}</small>
                        ${item.images && item.images.length > 0 ? `
                            <div class="mt-2">
                                ${item.images.slice(0, 3).map(img => `
                                    <img src="${img.url}" alt="${img.alt}" class="image-preview" style="max-width: 150px; margin-right: 10px;">
                                `).join('')}
                            </div>
                        ` : ''}
                        <p class="mt-2"><small>${(item.content || '').substring(0, 200)}...</small></p>
                    </div>
                `;
                preview.appendChild(card);
            });
        } else {
            document.getElementById('errorMessage').textContent = result.error || 'Unknown error';
            document.getElementById('crawlError').style.display = 'block';
        }
    } catch (error) {
        document.getElementById('crawlLoading').classList.remove('active');
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('crawlError').style.display = 'block';
    }
});

// Add to Sources
document.getElementById('addToSourcesBtn').addEventListener('click', async function() {
    const option = document.getElementById('defaultSource').selectedOptions[0];
    if (!option.value) {
        alert('Please select a source');
        return;
    }
    
    const data = {
        name: option.dataset.name,
        url: option.dataset.url,
        type: option.dataset.type,
        max_items: parseInt(document.getElementById('maxItems').value),
        frequency: document.getElementById('frequency').value,
        schedule_time: document.getElementById('scheduleTime').value,
        selectors: JSON.parse(option.dataset.selectors || '{}')
    };
    
    try {
        const response = await fetch('/api/sources/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.success) {
            alert('Source added successfully!');
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

// Custom Source Form
document.getElementById('customSourceForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const data = {
        name: document.getElementById('customName').value,
        url: document.getElementById('customUrl').value,
        type: document.getElementById('customType').value,
        frequency: document.getElementById('customFrequency').value,
        max_items: parseInt(document.getElementById('customMaxItems').value),
        schedule_time: '09:00'
    };
    
    try {
        const response = await fetch('/api/sources/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.success) {
            alert('Source added successfully!');
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

// Crawl configured source
async function crawlSource(sourceId) {
    if (!confirm('Start crawling this source?')) return;
    
    try {
        const response = await fetch(`/api/sources/${sourceId}/crawl`, {
            method: 'POST'
        });
        
        const result = await response.json();
        if (result.success) {
            alert(`Crawl successful! Collected ${result.result.items_collected} items.`);
        } else {
            alert('Crawl failed: ' + result.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Delete source
async function deleteSource(sourceId) {
    if (!confirm('Are you sure you want to delete this source?')) return;
    
    try {
        const response = await fetch(`/api/sources/${sourceId}/delete`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        if (result.success) {
            alert('Source deleted successfully!');
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
</script>
{% endblock %}
